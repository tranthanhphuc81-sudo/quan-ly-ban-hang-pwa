<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω b√°n h√†ng Standalone</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <style>
    body { background: #f8f8ff; font-family: 'Segoe UI', 'Roboto', Arial, sans-serif; }
    .container { max-width: 900px; margin: 0 auto; padding: 0 1.2em; }
    .section { padding: 1.5rem 0 0.5rem 0; }
    .tabs.is-fullwidth { background: #fff; border-bottom: 1.5px solid #e3e3e3; box-shadow: none; border-radius: 0; margin-bottom: 2rem; margin-top: 0; }
    .tabs.is-fullwidth ul { display: flex; width: 100%; background: none; box-shadow: none; border-radius: 0; }
    .tabs.is-fullwidth ul li { flex: 1 1 0; text-align: center; border-radius: 0; margin: 0 0.5em; }
    .tabs.is-fullwidth ul li a { width: 100%; display: block; padding: 0.7em 0; font-size: 1.08em; font-weight: 500; color: #2176d2; background: none; border-radius: 0; border-bottom: 2.5px solid transparent; transition: border-bottom 0.2s, color 0.2s; }
    .tabs.is-fullwidth ul li.is-active a { font-weight: 700; color: #2176d2; border-bottom: 2.5px solid #2176d2; background: none; }
    .tabs.is-fullwidth ul li:not(.is-active):hover a { color: #3273dc; border-bottom: 2.5px solid #e3f0ff; background: none; }
    .box, .card, .modal-content { border-radius: 12px; box-shadow: 0 2px 8px rgba(50,115,220,0.07); background: #fff; padding: 1.1em 1.2em; margin-bottom: 1.2rem; }
    .title, .subtitle { text-align: left; margin-bottom: 1.1rem; font-family: inherit; font-weight: 700; letter-spacing: 0.5px; color: #2176d2; }
    .table-responsive { overflow-x: auto; }
    .table { width: 100%; table-layout: fixed; font-size: 0.98em; }
    .table th, .table td { padding: 0.5em 0.3em; word-break: break-word; }
    .table th, .table td { min-width: 70px; }
    @media (max-width: 600px) {
      .container { max-width: 100vw; padding: 0 2vw; }
      .box, .card, .modal-content { padding: 0.7rem !important; margin-bottom: 1rem; border-radius: 10px; }
      .title, .subtitle { font-size: 1.1em; margin-bottom: 0.7rem; }
      .tabs { font-size: 1em; margin-bottom: 1rem; }
      .tabs.is-fullwidth ul { border-radius: 0; }
      .tabs.is-fullwidth ul li a { font-size: 1em; padding: 0.6em 0; border-radius: 0; }
      .table th:nth-child(5), .table td:nth-child(5), .table th:nth-child(6), .table td:nth-child(6) { display: none; }
      .table th, .table td { font-size: 0.95em; min-width: 60px; }
    }
  </style>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <section class="section">
      <div class="container">
        <div class="tabs is-toggle is-fullwidth is-large mb-4">
          <ul>
            <li class="is-active" id="tab-catalog"><a href="#" onclick="showTab('catalog')">H√†ng h√≥a</a></li>
            <li id="tab-sales"><a href="#" onclick="showTab('sales')">B√°n h√†ng</a></li>
            <li id="tab-report"><a href="#" onclick="showTab('report')">B√°o c√°o</a></li>
            <li id="tab-recycle"><a href="#" onclick="showTab('recycle')">Kh√¥i ph·ª•c/Xu·∫•t nh·∫≠p</a></li>
          </ul>
        </div>
        <div id="view-catalog" class="fade-in"></div>
        <div id="view-sales" class="is-hidden fade-in"></div>
        <div id="view-report" class="is-hidden fade-in"></div>
        <div id="view-recycle" class="is-hidden fade-in"></div>
      </div>
    </section>
    <style>
      body { background: #f8f8ff; font-family: 'Segoe UI', 'Roboto', Arial, sans-serif; }
      .container { max-width: 900px; margin: 0 auto; padding: 0 1.2em; }
      .section { padding: 1.5rem 0 0.5rem 0; }
      .tabs.is-fullwidth { background: #fff; border-bottom: 1.5px solid #e3e3e3; box-shadow: none; border-radius: 0; margin-bottom: 2rem; margin-top: 0; }
      .tabs.is-fullwidth ul { display: flex; width: 100%; background: none; box-shadow: none; border-radius: 0; }
      .tabs.is-fullwidth ul li { flex: 1 1 0; text-align: center; border-radius: 0; margin: 0 0.5em; }
      .tabs.is-fullwidth ul li a { width: 100%; display: block; padding: 0.7em 0; font-size: 1.08em; font-weight: 500; color: #2176d2; background: none; border-radius: 0; border-bottom: 2.5px solid transparent; transition: border-bottom 0.2s, color 0.2s; }
      .tabs.is-fullwidth ul li.is-active a { font-weight: 700; color: #2176d2; border-bottom: 2.5px solid #2176d2; background: none; }
      .tabs.is-fullwidth ul li:not(.is-active):hover a { color: #3273dc; border-bottom: 2.5px solid #e3f0ff; background: none; }
      .box, .card, .modal-content { border-radius: 12px; box-shadow: 0 2px 8px rgba(50,115,220,0.07); background: #fff; padding: 1.1em 1.2em; margin-bottom: 1.2rem; }
      .title, .subtitle { text-align: left; margin-bottom: 1.1rem; font-family: inherit; font-weight: 700; letter-spacing: 0.5px; color: #2176d2; }
      .table-responsive { overflow-x: auto; }
      .table { width: 100%; table-layout: fixed; font-size: 0.98em; }
      .table th, .table td { padding: 0.5em 0.3em; word-break: break-word; }
      .table th, .table td { min-width: 70px; }
      @media (max-width: 600px) {
        .container { max-width: 100vw; padding: 0 2vw; }
        .box, .card, .modal-content { padding: 0.7rem !important; margin-bottom: 1rem; border-radius: 10px; }
        .title, .subtitle { font-size: 1.1em; margin-bottom: 0.7rem; }
        .tabs { font-size: 1em; margin-bottom: 1rem; }
        .tabs.is-fullwidth ul { border-radius: 0; }
        .tabs.is-fullwidth ul li a { font-size: 1em; padding: 0.6em 0; border-radius: 0; }
        .table th:nth-child(5), .table td:nth-child(5), .table th:nth-child(6), .table td:nth-child(6) { display: none; }
        .table th, .table td { font-size: 0.95em; min-width: 60px; }
      }
    </style>
  <script>
    // Tab navigation
    function showTab(tab) {
      ['catalog','sales','report','recycle'].forEach(t => {
        document.getElementById('view-' + t).classList.add('is-hidden');
        document.getElementById('tab-' + t).classList.remove('is-active');
      });
      document.getElementById('view-' + tab).classList.remove('is-hidden');
      document.getElementById('tab-' + tab).classList.add('is-active');
    }
    // Qu·∫£n l√Ω h√†ng h√≥a
    function renderCatalog() {
      const products = JSON.parse(localStorage.getItem('products') || '[]');
      let html = `<h3 class='title is-5'>Qu·∫£n l√Ω H√†ng h√≥a</h3>
      <form id='product-form' class='box' autocomplete='off'>
        <div class='field'><label class='label'>T√™n s·∫£n ph·∫©m</label><div class='control'><input class='input' name='name' required></div></div>
        <div class='field'><label class='label'>M√£ v·∫°ch/ID</label>
          <div class='field has-addons'>
            <div class='control is-expanded'><input class='input' name='barcode' required></div>
            <div class='control'><button type='button' class='button is-small barcode-btn' onclick='scanBarcode()'><span class='barcode-icon'>üì∑</span>Qu√©t m√£ v·∫°ch</button></div>
          </div>
        </div>
        <div class='field'><label class='label'>Gi√° b√°n</label><div class='control'><input class='input' name='price' type='number' required></div></div>
        <div class='field'><label class='label'>Gi√° v·ªën</label><div class='control'><input class='input' name='cost' type='number'></div></div>
        <div class='field'><label class='label'>T·ªìn kho</label><div class='control'><input class='input' name='stock' type='number'></div></div>
        <div class='field'><label class='label'>Nh√≥m h√†ng</label><div class='control'><input class='input' name='category'></div></div>
        <div class='field'><label class='label'>Ng√†y nh·∫≠p</label><div class='control'><input class='input' name='importDate' type='date'></div></div>
        <div class='field'><label class='label'>Ng∆∞·ªùi cung c·∫•p</label><div class='control'><input class='input' name='supplier'></div></div>
        <div class='field'><button class='button is-primary' type='submit'>Th√™m s·∫£n ph·∫©m</button></div>
      </form>`;
      html += `<div id='low-stock-warning'></div>`;
      html += `<div class='mt-4'><h4 class='subtitle is-6'>Danh s√°ch s·∫£n ph·∫©m</h4>`;
      if (products.length === 0) html += `<div class='has-text-grey'>Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o.</div>`;
      html += `<div class='columns is-multiline'>`;
      products.forEach(p => {
        html += `<div class='column is-half-mobile is-one-third-tablet is-one-quarter-desktop'>
          <div class='card product-card'>
            <div class='card-content'>
              <div class='is-flex is-align-items-center mb-2'>
                <span class='icon is-large has-text-link' style='font-size:1.7em;margin-right:0.5em;'>üì¶</span>
                <strong>${p.name}</strong> <span class='tag is-light ml-2'>${p.barcode}</span>
              </div>
              <div>Gi√° b√°n: <strong>${p.price}</strong> | Gi√° v·ªën: ${p.cost||'-'} | T·ªìn kho: <span${p.stock==0?" class='out-stock'":p.stock<=3?" class='low-stock'":''}>${p.stock}</span></div>
              <div>Nh√≥m: ${p.category||'-'} | Ng√†y nh·∫≠p: ${p.importDate||'-'} | NCC: ${p.supplier||'V√£ng lai'}</div>
              <div class='buttons mt-2'><button class='button is-small' onclick='editProduct(${p.id})'>S·ª≠a</button><button class='button is-small is-danger' onclick='deleteProduct(${p.id})'>X√≥a</button></div>
            </div>
          </div>
        </div>`;
      });
      html += `</div></div>`;
      document.getElementById('view-catalog').innerHTML = html;
      renderLowStock(products);
    }
    function renderLowStock(products) {
      const lows = products.filter(p => p.stock <= 3);
      let html = '';
      if (lows.length > 0) {
        html += `<div class='notification is-warning is-light'><strong>C·∫£nh b√°o s·∫Øp h·∫øt h√†ng:</strong> `;
        lows.forEach(p => {
          html += `<div>${p.name} (c√≤n ${p.stock}) <span class='has-text-grey'>- nh·∫≠p: ${p.importDate||'-'}</span></div>`;
        });
        html += `</div>`;
      }
      document.getElementById('low-stock-warning').innerHTML = html;
    }
    let editingProductId = null;
    function editProduct(id) {
      const products = JSON.parse(localStorage.getItem('products') || '[]');
      const prod = products.find(p => p.id === id);
      if (!prod) return;
      editingProductId = id;
      document.getElementById('product-form').name.value = prod.name;
      document.getElementById('product-form').barcode.value = prod.barcode;
      document.getElementById('product-form').price.value = prod.price;
      document.getElementById('product-form').cost.value = prod.cost;
      document.getElementById('product-form').stock.value = prod.stock;
      document.getElementById('product-form').category.value = prod.category;
      document.getElementById('product-form').importDate.value = prod.importDate;
      document.getElementById('product-form').supplier.value = prod.supplier;
      document.getElementById('product-form').querySelector('button[type="submit"]').textContent = 'C·∫≠p nh·∫≠t';
    }
    document.addEventListener('submit', function(e) {
      if (e.target && e.target.id === 'product-form') {
        e.preventDefault();
        const f = e.target;
        let products = JSON.parse(localStorage.getItem('products') || '[]');
        if (editingProductId) {
          // c·∫≠p nh·∫≠t
          products = products.map(p => p.id === editingProductId ? {
            ...p,
            name: f.name.value,
            barcode: f.barcode.value,
            price: +f.price.value,
            cost: +f.cost.value||0,
            stock: +f.stock.value||0,
            category: f.category.value,
            importDate: f.importDate.value||new Date().toISOString().slice(0,10),
            supplier: f.supplier.value||'V√£ng lai'
          } : p);
          editingProductId = null;
          f.querySelector('button[type="submit"]').textContent = 'Th√™m s·∫£n ph·∫©m';
        } else {
          // th√™m m·ªõi
          const prod = {
            id: Date.now(),
            name: f.name.value,
            barcode: f.barcode.value,
            price: +f.price.value,
            cost: +f.cost.value||0,
            stock: +f.stock.value||0,
            category: f.category.value,
            importDate: f.importDate.value||new Date().toISOString().slice(0,10),
            supplier: f.supplier.value||'V√£ng lai'
          };
          products.push(prod);
        }
        localStorage.setItem('products', JSON.stringify(products));
        renderCatalog();
      }
    });
    function deleteProduct(id) {
      if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) {
        let products = JSON.parse(localStorage.getItem('products') || '[]');
        let deletedProducts = JSON.parse(localStorage.getItem('deletedProducts') || '[]');
        const prod = products.find(p => p.id === id);
        if (prod) deletedProducts.push(prod);
        products = products.filter(p => p.id !== id);
        localStorage.setItem('products', JSON.stringify(products));
        localStorage.setItem('deletedProducts', JSON.stringify(deletedProducts));
        renderCatalog();
      }
    }
    let barcodeScanner = null;
    function scanBarcode() {
      if (barcodeScanner) return;
      const modal = document.createElement('div');
      modal.innerHTML = `<div class='modal is-active'><div class='modal-background'></div><div class='modal-content'><div id='barcode-reader' style='width:300px;height:300px;margin:auto;'></div></div><button class='modal-close is-large'></button></div>`;
      document.body.appendChild(modal);
      barcodeScanner = new Html5Qrcode('barcode-reader');
      barcodeScanner.start({ facingMode: 'environment' }, { fps: 10, qrbox: 250 },
        code => {
          document.getElementById('product-form').barcode.value = code;
          closeBarcodeModal();
        }
      );
      modal.querySelector('.modal-close').onclick = closeBarcodeModal;
    }
    function closeBarcodeModal() {
      if (barcodeScanner) barcodeScanner.stop();
      barcodeScanner = null;
      document.querySelector('.modal').remove();
    }
    // B√°n h√†ng
    function renderSales() {
      const products = JSON.parse(localStorage.getItem('products') || '[]');
      const orders = JSON.parse(localStorage.getItem('orders') || '[]');
      let cart = [];
      let html = `<h3 class='title is-5'>B√°n h√†ng / T√≠nh ti·ªÅn</h3>
      <form id='sales-form' class='box'>
        <div class='field'><label class='label'>T√¨m ki·∫øm/M√£ v·∫°ch</label><div class='control'><input class='input' id='sales-search'></div></div>
        <div class='field'><label class='label'>T√™n ng∆∞·ªùi mua</label><div class='control'><input class='input' id='sales-buyer' placeholder='V√£ng lai'></div></div>
        <div class='field'><button class='button is-info' type='button' id='scan-barcode-sales'><span class='barcode-icon'>üì∑</span>Qu√©t m√£ v·∫°ch</button></div>
      </form>`;
      html += `<div id='sales-products'></div>`;
      html += `<h4 class='subtitle is-6'>Gi·ªè h√†ng</h4><div id='sales-cart'></div>`;
      html += `<div id='sales-total'></div><button class='button is-success mt-2' id='sales-pay'>Thanh to√°n</button>`;
      html += `<div id='sales-lastorder'></div>`;
      document.getElementById('view-sales').innerHTML = html;
      let search = '';
      document.getElementById('sales-search').oninput = function(e) {
        search = e.target.value.toLowerCase();
        renderSalesProducts();
      };
      function renderSalesProducts() {
        let filtered = products.filter(p => p.name.toLowerCase().includes(search) || p.barcode.includes(search));
        let html = '';
        filtered.forEach(p => {
          html += `<div class='card mb-2'><div class='card-content'>
            <div><strong>${p.name}</strong> <span class='tag is-light'>${p.barcode}</span></div>
            <div>Gi√° b√°n: <strong>${p.price}</strong> | T·ªìn kho: <span${p.stock==0?" class='out-stock'":p.stock<=3?" class='low-stock'":''}>${p.stock}</span></div>
            <button class='button is-small' onclick='addToCart(${p.id})'>Th√™m v√†o gi·ªè</button>
          </div></div>`;
        });
        document.getElementById('sales-products').innerHTML = html;
      }
      window.addToCart = function(id) {
        const prod = products.find(p => p.id === id);
        if (!prod || prod.stock <= 0) return alert('Kh√¥ng c√≤n t·ªìn kho!');
        const found = cart.find(item => item.id === id);
        if (found) found.qty++;
        else cart.push({ ...prod, qty: 1 });
        renderCart();
      };
      function renderCart() {
        let html = '';
        let total = 0;
        cart.forEach(item => {
          total += item.price * item.qty;
          html += `<div>${item.name} x ${item.qty} = <strong>${(item.price*item.qty).toLocaleString()}</strong> <button class='button is-small' onclick='changeQty(${item.id},-1)'>-</button> <button class='button is-small' onclick='changeQty(${item.id},1)'>+</button></div>`;
        });
        document.getElementById('sales-cart').innerHTML = html;
        document.getElementById('sales-total').innerHTML = `<strong>T·ªïng ti·ªÅn: ${total.toLocaleString()} VND</strong>`;
      }
      window.changeQty = function(id, delta) {
        const found = cart.find(item => item.id === id);
        if (found) {
          found.qty = Math.max(1, found.qty + delta);
          renderCart();
        }
      };
      document.getElementById('sales-pay').onclick = function() {
        if (cart.length === 0) return alert('Gi·ªè h√†ng tr·ªëng!');
        // Tr·ª´ t·ªìn kho
        cart.forEach(item => {
          const idx = products.findIndex(p => p.id === item.id);
          if (idx >= 0) products[idx].stock = Math.max(0, products[idx].stock - item.qty);
        });
        localStorage.setItem('products', JSON.stringify(products));
        // L∆∞u ƒë∆°n h√†ng
        const buyer = document.getElementById('sales-buyer').value.trim() || 'V√£ng lai';
        const order = {
          id: 'DH' + Date.now(),
          items: cart,
          total: cart.reduce((sum, item) => sum + item.price * item.qty, 0),
          buyer,
          createdAt: new Date().toISOString()
        };
        orders.push(order);
        localStorage.setItem('orders', JSON.stringify(orders));
        document.getElementById('sales-lastorder').innerHTML = `<div class='notification is-success'>ƒê√£ thanh to√°n! M√£ ƒë∆°n: ${order.id}, Ng∆∞·ªùi mua: ${buyer}, T·ªïng: ${order.total.toLocaleString()} VND</div>`;
        cart = [];
        renderCart();
        renderSalesProducts();
      };
      document.getElementById('scan-barcode-sales').onclick = function() {
        if (barcodeScanner) return;
        const modal = document.createElement('div');
        modal.innerHTML = `<div class='modal is-active'><div class='modal-background'></div><div class='modal-content'><div id='barcode-reader-sales' style='width:300px;height:300px;margin:auto;'></div></div><button class='modal-close is-large'></button></div>`;
        document.body.appendChild(modal);
        barcodeScanner = new Html5Qrcode('barcode-reader-sales');
        barcodeScanner.start({ facingMode: 'environment' }, { fps: 10, qrbox: 250 },
          code => {
            document.getElementById('sales-search').value = code;
            document.getElementById('sales-search').dispatchEvent(new Event('input'));
            closeBarcodeModal();
          }
        );
        modal.querySelector('.modal-close').onclick = closeBarcodeModal;
      }
    }
    // B√°o c√°o
    function renderReport() {
      const products = JSON.parse(localStorage.getItem('products') || '[]');
      const orders = JSON.parse(localStorage.getItem('orders') || '[]');
      const today = new Date().toISOString().slice(0,10);
      const todayOrders = orders.filter(o => o.createdAt && o.createdAt.slice(0,10) === today);
      const totalOrders = todayOrders.length;
      const totalRevenue = todayOrders.reduce((sum, o) => sum + o.total, 0);
      const totalProfit = todayOrders.reduce((sum, o) => sum + o.items.reduce((pSum, item) => {
        const prod = products.find(p => p.id === item.id);
        return pSum + (item.price - (prod?.cost || 0)) * item.qty;
      }, 0), 0);
      const lowStock = products.filter(p => p.stock <= 3);
      const totalInventoryCost = products.reduce((sum, p) => sum + (p.cost || 0) * (p.stock || 0), 0);
      const allRevenue = orders.reduce((sum, o) => sum + (o.total || 0), 0);
      let html = `<h2 class='title is-4 has-text-left mb-4'>B√°o c√°o ng√†y</h2>
      <div class='box report-box mb-3'><span class='has-text-weight-semibold'>T·ªïng doanh thu to√†n b·ªô:</span> <span class='has-text-black has-text-weight-bold'>${allRevenue.toLocaleString()} VND</span></div>`;
      html += `<div class='box report-box mb-3'>
        <div><span class='has-text-weight-semibold'>T·ªïng s·ªë ƒë∆°n h√†ng h√¥m nay:</span> <span class='has-text-black'>${totalOrders}</span></div>
        <div><span class='has-text-weight-semibold'>T·ªïng doanh thu h√¥m nay:</span> <span class='has-text-black'>${totalRevenue.toLocaleString()} VND</span></div>
        <div><span class='has-text-weight-semibold'>T·ªïng l·ª£i nhu·∫≠n h√¥m nay:</span> <span class='has-text-black'>${totalProfit.toLocaleString()} VND</span></div>
        ${lowStock.length > 0 ? `<div class='mt-2'><span class='has-text-danger has-text-weight-bold'>C·∫£nh b√°o s·∫Øp h·∫øt h√†ng:</span><ul class='mt-1'>${lowStock.map(p => `<li><span class='has-text-black'>${p.name} (c√≤n ${p.stock})</span> <span class='has-text-grey'>- nh·∫≠p: ${p.importDate||'-'}</span></li>`).join('')}</ul></div>` : ''}
      </div>`;
      html += `<h2 class='title is-4 has-text-left mb-3'>B√°o c√°o t·ªìn kho</h2>`;
      html += `<div class='box report-box mb-3'><span class='has-text-weight-semibold'>T·ªïng gi√° v·ªën h√†ng t·ªìn kho:</span> <span class='has-text-black has-text-weight-bold'>${totalInventoryCost.toLocaleString()} VND</span></div>`;
      html += `<div class='box table-responsive mb-4'><table class='table is-fullwidth is-size-7'>
        <thead style='background:#e3f0ff;'>
          <tr><th class='has-text-weight-bold'>T√™n h√†ng</th><th class='has-text-weight-bold'>T·ªìn kho</th><th class='has-text-weight-bold'>Gi√° v·ªën</th><th class='has-text-weight-bold'>Th√†nh ti·ªÅn</th><th class='has-text-weight-bold'>Ng√†y nh·∫≠p</th><th class='has-text-weight-bold'>Ng∆∞·ªùi cung c·∫•p</th></tr>
        </thead><tbody>`;
      products.forEach(p => {
        html += `<tr><td>${p.name}</td><td>${p.stock}</td><td>${p.cost?.toLocaleString()||0} VND</td><td>${((p.cost||0)*(p.stock||0)).toLocaleString()} VND</td><td>${p.importDate||'-'}</td><td>${p.supplier||'V√£ng lai'}</td></tr>`;
      });
      html += `</tbody></table></div>`;
      document.getElementById('view-report').innerHTML = html;
    }
    // Xu·∫•t b√°o c√°o Excel
    function exportReportExcel() {
      if (typeof XLSX === 'undefined') {
        alert('SheetJS ch∆∞a ƒë∆∞·ª£c t·∫£i.');
        return;
      }
      const products = JSON.parse(localStorage.getItem('products') || '[]');
      const orders = JSON.parse(localStorage.getItem('orders') || '[]');
      const lowStock = products.filter(p => p.stock <= 3);
      const wb = XLSX.utils.book_new();
      wb.SheetNames.push('B√°o c√°o t·ªìn kho');
      wb.Sheets['B√°o c√°o t·ªìn kho'] = XLSX.utils.json_to_sheet(products);
      wb.SheetNames.push('ƒê∆°n h√†ng');
      wb.Sheets['ƒê∆°n h√†ng'] = XLSX.utils.json_to_sheet(orders);
      wb.SheetNames.push('H√†ng s·∫Øp h·∫øt');
      wb.Sheets['H√†ng s·∫Øp h·∫øt'] = XLSX.utils.json_to_sheet(lowStock);
      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'binary'});
      const buf = new ArrayBuffer(wbout.length);
      const view = new Uint8Array(buf);
      for (let i=0; i<wbout.length; ++i) view[i] = wbout.charCodeAt(i) & 0xFF;
      const blob = new Blob([buf], {type:'application/octet-stream'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'baocao.xlsx';
      a.click();
      URL.revokeObjectURL(url);
    }
    // Backup d·ªØ li·ªáu JSON
    function backupData() {
      const data = {
        products: JSON.parse(localStorage.getItem('products') || '[]'),
        orders: JSON.parse(localStorage.getItem('orders') || '[]'),
        deletedProducts: JSON.parse(localStorage.getItem('deletedProducts') || '[]'),
        deletedOrders: JSON.parse(localStorage.getItem('deletedOrders') || '[]'),
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'backup_data.json';
      a.click();
      URL.revokeObjectURL(url);
    }
    // Kh√¥i ph·ª•c/Xu·∫•t nh·∫≠p
    function renderRecycle() {
      const deletedProducts = JSON.parse(localStorage.getItem('deletedProducts') || '[]');
      const orders = JSON.parse(localStorage.getItem('orders') || '[]');
      let html = `<h3 class='title is-5'>Kh√¥i ph·ª•c/Xu·∫•t nh·∫≠p h√†ng h√≥a</h3>
      <div class='tabs is-toggle'>
        <ul>
          <li class='is-active' id='tab-recycle-products'><a href='#' onclick='showRecycleTab("products")'>S·∫£n ph·∫©m ƒë√£ x√≥a</a></li>
          <li id='tab-recycle-orders'><a href='#' onclick='showRecycleTab("orders")'>ƒê∆°n h√†ng ƒë√£ x√≥a</a></li>
        </ul>
      </div>
      <div id='recycle-products' class='box'></div>
      <div id='recycle-orders' class='box is-hidden'></div>`;
      document.getElementById('view-recycle').innerHTML = html;
      renderRecycleProducts(deletedProducts);
      renderRecycleOrders(orders.filter(o => o.id.startsWith('DH')));
    }
    function showRecycleTab(tab) {
      ['products','orders'].forEach(t => {
        document.getElementById('recycle-' + t).classList.add('is-hidden');
        document.getElementById('tab-recycle-' + t).classList.remove('is-active');
      });
      document.getElementById('recycle-' + tab).classList.remove('is-hidden');
      document.getElementById('tab-recycle-' + tab).classList.add('is-active');
    }
    function renderRecycleProducts(products) {
      let html = `<h4 class='subtitle is-6'>S·∫£n ph·∫©m ƒë√£ x√≥a</h4>`;
      if (products.length === 0) html += `<div class='has-text-grey'>Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o b·ªã x√≥a.</div>`;
      products.sort((a,b) => (b.importDate||'').localeCompare(a.importDate||''));
      products.forEach(p => {
        html += `<div class='card'><div class='card-content'>
          <div><strong>${p.name}</strong> <span class='tag is-light'>${p.barcode}</span></div>
          <div>Gi√° b√°n: <strong>${p.price}</strong> | Gi√° v·ªën: ${p.cost||'-'} | T·ªìn kho: <span${p.stock==0?" class='out-stock'":p.stock<=3?" class='low-stock'":''}>${p.stock}</span></div>
          <div>Nh√≥m: ${p.category||'-'} | Ng√†y nh·∫≠p: ${p.importDate||'-'} | NCC: ${p.supplier||'V√£ng lai'}</div>
          <div class='buttons mt-2'><button class='button is-small' onclick='restoreProduct(${p.id})'>Kh√¥i ph·ª•c</button></div>
        </div></div>`;
      });
      document.getElementById('recycle-products').innerHTML = html;
    }
    function renderRecycleOrders(orders) {
      let html = `<h4 class='subtitle is-6'>ƒê∆°n h√†ng ƒë√£ x√≥a</h4>`;
      if (orders.length === 0) html += `<div class='has-text-grey'>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o b·ªã x√≥a.</div>`;
      orders.sort((a,b) => (b.createdAt||'').localeCompare(a.createdAt||''));
      orders.forEach(order => {
        html += `<div class='card'><div class='card-content'>
          <div><strong>M√£ ƒë∆°n: ${order.id}</strong></div>
          <div>Ng√†y b√°n: ${order.createdAt.slice(0,10)} | Ng∆∞·ªùi mua: ${order.buyer||'V√£ng lai'}</div>
          <div>S·∫£n ph·∫©m: <ul>`;
        order.items.forEach(item => {
          html += `<li>${item.name} x ${item.qty}</li>`;
        });
        html += `</ul></div>
          <div class='buttons mt-2'><button class='button is-small' onclick='restoreOrder("${order.id}")'>Kh√¥i ph·ª•c</button></div>
        </div></div>`;
      });
      document.getElementById('recycle-orders').innerHTML = html;
    }
    window.restoreProduct = function(id) {
      let products = JSON.parse(localStorage.getItem('products') || '[]');
      let deletedProducts = JSON.parse(localStorage.getItem('deletedProducts') || '[]');
      const prod = deletedProducts.find(p => p.id === id);
      if (prod) {
        products.push(prod);
        deletedProducts = deletedProducts.filter(p => p.id !== id);
        localStorage.setItem('products', JSON.stringify(products));
        localStorage.setItem('deletedProducts', JSON.stringify(deletedProducts));
        renderRecycle();
        renderCatalog();
      }
    }
    window.restoreOrder = function(orderId) {
      let orders = JSON.parse(localStorage.getItem('orders') || '[]');
      let deletedOrders = JSON.parse(localStorage.getItem('deletedOrders') || '[]');
      const order = deletedOrders.find(o => o.id === orderId);
      if (order) {
        orders.push(order);
        deletedOrders = deletedOrders.filter(o => o.id !== orderId);
        localStorage.setItem('orders', JSON.stringify(orders));
        localStorage.setItem('deletedOrders', JSON.stringify(deletedOrders));
        renderRecycle();
        renderReport();
      }
    }
    // Kh·ªüi t·∫°o
    document.addEventListener('DOMContentLoaded', function() {
      renderCatalog();
      document.getElementById('tab-catalog').addEventListener('click', renderCatalog);
      document.getElementById('tab-sales').addEventListener('click', renderSales);
      document.getElementById('tab-report').addEventListener('click', renderReport);
      document.getElementById('tab-recycle').addEventListener('click', renderRecycle);
    });
  </script>
</body>
</html>
